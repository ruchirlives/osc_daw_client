name: macOS build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Detect Projucer scheme
        id: projucer_scheme
        run: |
          SCHEME=$(xcodebuild -list -json -project JUCE/extras/Projucer/Builds/MacOSX/Projucer.xcodeproj | \
          python3 -c "import json,sys; d=json.load(sys.stdin); print(d['project']['schemes'][0])")
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
          echo "Using scheme: $SCHEME"

      - name: Build Projucer (from JUCE submodule)
        run: |
          xcodebuild \
          -project JUCE/extras/Projucer/Builds/MacOSX/Projucer.xcodeproj \
          -scheme "${{ steps.projucer_scheme.outputs.scheme }}" \
          -configuration Release \
          -derivedDataPath build/Projucer \
          build

      - name: Resave .jucer to generate Xcode project
        run: |
          set -euo pipefail

          echo "Contents of build/Projucer/Build/Products (recursive):"
          find build/Projucer/Build/Products -maxdepth 6 -print || true

          echo "Searching for Projucer executable inside an app bundle..."
          PROJUCER_BIN=$(find build/Projucer -type f -path "*/Projucer.app/Contents/MacOS/Projucer" -print -quit || true)

          if [ -z "${PROJUCER_BIN}" ]; then
          echo "Projucer binary not found. Searching for any *.app in build/Projucer:"
          find build/Projucer -type d -name "*.app" -maxdepth 10 -print || true

          echo "Searching for any executable named Projucer (may be in a different bundle name):"
          find build/Projucer -type f -name "Projucer" -maxdepth 12 -print || true

          exit 1
          fi

          echo "Using Projucer: ${PROJUCER_BIN}"
          chmod +x "${PROJUCER_BIN}"
          "${PROJUCER_BIN}" --resave OSC_Client.jucer

      - name: Build plugin (Xcode)
        run: |
          xcodebuild \
            -project Builds/MacOSX/OSC_Client.xcodeproj \
            -configuration Release \
            -derivedDataPath build/Plugin

      - name: List build products
        run: |
          echo "Searching for vst3/component/app bundles..."
          find build/Plugin -maxdepth 6 -type d \( -name "*.vst3" -o -name "*.component" -o -name "*.app" \) -print

      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: macOS-build
          path: |
            build/Plugin/**/**/*.vst3
            build/Plugin/**/**/*.component
            build/Plugin/**/**/*.app
          if-no-files-found: warn
