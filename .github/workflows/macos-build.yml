name: macOS build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Detect Projucer scheme
        id: projucer_scheme
        run: |
          set -euo pipefail
          SCHEME=$(xcodebuild -list -json -project JUCE/extras/Projucer/Builds/MacOSX/Projucer.xcodeproj | \
            python3 -c "import json,sys; d=json.load(sys.stdin); print(d['project']['schemes'][0])")
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"
          echo "Using scheme: $SCHEME"

      - name: Build Projucer (from JUCE submodule)
        run: |
          set -euo pipefail
          OUTDIR="$PWD/build/ProjucerOut"
          mkdir -p "$OUTDIR"

          xcodebuild \
            -project JUCE/extras/Projucer/Builds/MacOSX/Projucer.xcodeproj \
            -scheme "${{ steps.projucer_scheme.outputs.scheme }}" \
            -configuration Release \
            -sdk macosx \
            -destination "generic/platform=macOS" \
            CONFIGURATION_BUILD_DIR="$OUTDIR" \
            build

          echo "ProjucerOut contents:"
          find "$OUTDIR" -maxdepth 4 -print

      - name: Set JUCE module path for Projucer (CI)
        run: |
          set -euo pipefail
          PROJUCER_BIN="$PWD/build/ProjucerOut/Projucer.app/Contents/MacOS/Projucer"
          chmod +x "$PROJUCER_BIN"
          "$PROJUCER_BIN" --set-global-search-path osx defaultJuceModulePath "$PWD/JUCE/modules"

      - name: Resave .jucer to generate Xcode project
        run: |
          set -euo pipefail
          PROJUCER_BIN="$PWD/build/ProjucerOut/Projucer.app/Contents/MacOS/Projucer"
          chmod +x "$PROJUCER_BIN"
          "$PROJUCER_BIN" --resave OSC_Client.jucer --fix-missing-dependencies

      - name: Detect plugin scheme
        id: plugin_scheme
        run: |
          set -euo pipefail
          SCHEME=$(xcodebuild -list -json -project Builds/MacOSX/OSC_Client.xcodeproj | \
          python3 -c "import json,sys; d=json.load(sys.stdin); print(d['project']['schemes'][0])")
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"
          echo "Using scheme: $SCHEME"

      - name: Build plugin (Xcode)
        run: |
          set -euo pipefail
          xcodebuild \
          -project Builds/MacOSX/OSC_Client.xcodeproj \
          -scheme "${{ steps.plugin_scheme.outputs.scheme }}" \
          -configuration Release \
          -derivedDataPath build/Plugin \
          build

      - name: Collect build products
        run: |
          set -euo pipefail
          mkdir -p artifacts

          echo "Searching for VST3/AU outputs..."
          find . -type d \( -name "*.vst3" -o -name "*.component" \) -print

          # Copy any found bundles into ./artifacts (preserves bundle structure)
          while IFS= read -r bundle; do
            echo "Copying: $bundle"
            cp -R "$bundle" artifacts/
          done < <(find . -type d \( -name "*.vst3" -o -name "*.component" \))

          echo "Artifacts folder contents:"
          find artifacts -maxdepth 3 -print

      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: macOS-build
          path: artifacts/**
          if-no-files-found: warn
